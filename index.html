<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F√¶sh</title>
  <link rel="icon" href="./favicon.ico" />

  <style>
    :root{
      --bg:#0b0b12;
      --panel:#12121a;
      --panel2:#0f0f16;
      --line:#1f1f2e;
      --text:#ececf7;
      --muted:#b9bad3;
      --accent:#7c5cff;
      --good:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff5c7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -10%, #1a1a2c 0%, var(--bg) 55%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(820px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,18,26,.95), rgba(12,12,18,.92));
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    header{
      padding:12px 16px;
      background: #12121a;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--good);
      box-shadow:0 0 0 4px rgba(61,220,151,.12);
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }
    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      font-weight:650;
      user-select:none;
    }
    .pill input[type="range"]{ width:120px; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition:.12s transform ease, .12s background ease;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06);}
    .btn:active{transform: translateY(0px);}
    .btnAccent{
      border-color: rgba(124,92,255,.45);
      background: rgba(124,92,255,.12);
    }
    .main{
      display:flex;
      flex-direction:column;
      height:min(72vh, 640px);
      background: #0e0e15;
    }
    #chat{
      padding:16px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .row.you{justify-content:flex-end}
    .bubble{
      max-width:min(78%, 680px);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      line-height:1.25;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .bubble.you{
      background: rgba(124,92,255,.13);
      border-color: rgba(124,92,255,.35);
    }
    .bubble.faesh{
      background: rgba(255,255,255,.04);
    }
    .meta{
      font-size:11px;
      color:var(--muted);
      margin:0 6px;
      font-weight:650;
    }
    .composer{
      padding:12px;
      border-top:1px solid var(--line);
      background: #0f0f16;
      display:flex;
      gap:10px;
      align-items:center;
    }
    #input{
      flex:1;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
      font-weight:650;
    }
    #input::placeholder{color:rgba(185,186,211,.65)}
    .tiny{
      font-size:12px;
      color:var(--muted);
      padding:10px 16px;
      border-top:1px solid var(--line);
      background:#0e0e15;
    }
    .hiddenInput{display:none;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">
          <span class="dot"></span>
          <span>F√¶sh</span>
        </div>
        <div class="sub">Fashion + creativity sidekick</div>
      </div>

      <div class="controls">
        <label class="pill" title="Only roasts if > 0 (safe)">
          <span>Roast</span>
          <input id="roast" type="range" min="0" max="5" value="0" />
          <span id="roastVal">0</span>
        </label>

        <button class="btn" id="imgBtn" title="Send an image">üñºÔ∏è</button>
        <button class="btn" id="fileBtn" title="Send a file">üìé</button>
        <button class="btn btnAccent" id="sendBtn">Send</button>
      </div>
    </header>

    <div class="main">
      <div id="chat"></div>

      <div class="composer">
        <input id="input" placeholder="Say something‚Ä¶" autocomplete="off" />
        <input class="hiddenInput" id="imgInput" type="file" accept="image/*" />
        <input class="hiddenInput" id="fileInput" type="file" />
      </div>

      <div class="tiny">
        Tip: Press <b>Enter</b> to send. Try <b>Sensei</b> for deep answers, <b>Toasted 3D</b> to return to fashion.
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://faesh.onrender.com";

    let history = [];
    let sessionState = {}; // IMPORTANT: persisted backend state

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const roastEl = document.getElementById("roast");
    const roastValEl = document.getElementById("roastVal");
    const imgBtn = document.getElementById("imgBtn");
    const fileBtn = document.getElementById("fileBtn");
    const imgInput = document.getElementById("imgInput");
    const fileInput = document.getElementById("fileInput");

    function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }

    function addMessage(who, text) {
      const row = document.createElement("div");
      row.className = `row ${who === "you" ? "you" : "faesh"}`;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = who === "you" ? "You" : "F√¶sh";

      const bubble = document.createElement("div");
      bubble.className = `bubble ${who === "you" ? "you" : "faesh"}`;
      bubble.textContent = text;

      if (who === "you") { row.appendChild(bubble); row.appendChild(meta); }
      else { row.appendChild(meta); row.appendChild(bubble); }

      chatEl.appendChild(row);
      scrollToBottom();
    }

    function setRoastLabel() { roastValEl.textContent = String(roastEl.value); }
    setRoastLabel();
    roastEl.addEventListener("input", setRoastLabel);

    async function getJSON(path, timeoutMs = 15000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(`${API_BASE}${path}`, { method: "GET", mode: "cors", signal: ctrl.signal });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.detail || `Backend error (${res.status})`);
        return data;
      } finally {
        clearTimeout(t);
      }
    }

    async function postJSON(path, payload, timeoutMs = 15000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(`${API_BASE}${path}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          mode: "cors",
          signal: ctrl.signal
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.detail || data?.message || `Backend error (${res.status})`);
        return data;
      } finally {
        clearTimeout(t);
      }
    }

    async function sendMessage() {
      const text = (inputEl.value || "").trim();
      if (!text) return;

      inputEl.value = "";
      addMessage("you", text);

      history.push({ role: "user", content: text });
      history = history.slice(-20);

      const roast_level = Number(roastEl.value || 0);

      try {
        const payload = {
          message: text,
          messages: history,
          roast_level: roast_level,
          session_state: sessionState
        };

        const data = await postJSON("/chat", payload);

        const reply = (data && (data.reply || data.message)) ? (data.reply || data.message) : "‚Ä¶";
        sessionState = (data && data.session_state) ? data.session_state : sessionState;

        addMessage("faesh", reply);

        history.push({ role: "assistant", content: reply });
        history = history.slice(-20);

      } catch (err) {
        addMessage("faesh", `‚ö†Ô∏è Faesh froze ‚Äî backend didn‚Äôt respond. ${err?.message ? "(" + err.message + ")" : ""}`);
      }
    }

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    sendBtn.addEventListener("click", () => sendMessage());

    imgBtn.addEventListener("click", () => imgInput.click());
    fileBtn.addEventListener("click", () => fileInput.click());

    imgInput.addEventListener("change", async () => {
      if (!imgInput.files || !imgInput.files[0]) return;
      addMessage("you", "üñºÔ∏è (image selected)");
      addMessage("faesh", "Image received üñºÔ∏è ‚Äî fashion vision coming soon");
      imgInput.value = "";
    });

    fileInput.addEventListener("change", async () => {
      if (!fileInput.files || !fileInput.files[0]) return;
      addMessage("you", "üìé (file selected)");
      addMessage("faesh", "File received üìé ‚Äî creative tools coming soon");
      fileInput.value = "";
    });

    // ‚úÖ INITIAL GREETING (FROM BACKEND, RANDOM, NO NAME)
    (async function boot() {
      try {
        const data = await getJSON("/greet");
        addMessage("faesh", data?.reply || "Hey! F√¶sh here ‚Äî what vibe are we on today?");
      } catch (e) {

      }
    })();
  </script>
</body>
</html>
